name: React Native iOS Deploy

on:
  workflow_dispatch:

jobs:
  build-deploy-ios:
    runs-on: macos-latest
    
    steps:
    - name: Checkout app repo
      uses: actions/checkout@v4
      with:
        repository: dogvatar-dog/dogvatarmobile
        token: ${{ secrets.EXTERNAL_REPO_TOKEN }}
    
    - name: Setup Node
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Install dependencies
      run: npm install
    
    - name: Install CocoaPods
      run: cd ios && pod install
    
    - name: Build iOS
      run: |
        cd ios
        xcodebuild -workspace *.xcworkspace \
          -scheme $(xcodebuild -list -json | jq -r '.workspace.schemes[0]') \
          -configuration Release \
          -destination generic/platform=iOS \
          -archivePath build/App.xcarchive \
          archive
    
    - name: Export IPA
      run: |
        cd ios
        xcodebuild -exportArchive \
          -archivePath build/App.xcarchive \
          -exportPath build \
          -exportOptionsPlist ../ExportOptions.plist
    
    - name: Upload to App Store
      env:
        API_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
        API_ISSUER: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
      run: |
        xcrun altool --upload-app \
          --type ios \
          --file ios/build/*.ipa \
          --apiKey $API_KEY \
          --apiIssuer $API_ISSUER
